#!/bin/bash
#
# UnrealIRCd Web Panel - Build & Management Script
# Usage: ./uwp <command>
#

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
BACKEND_DIR="$SCRIPT_DIR/backend"
FRONTEND_DIR="$SCRIPT_DIR/frontend"
BINARY_NAME="webpanel"
PID_FILE="$BACKEND_DIR/data/webpanel.pid"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# ASCII art logo encoded as decimal values
UNREALLOGO_CHARS=(
32 95 32 32 32 95 32 32 32 32 32
32 32 32 32 32 32 32 32 32 32 32
32 32 32 32 32 32 95 95 95 95 95
95 95 95 95 95 95 95 32 32 95 95
95 95 95 32 32 32 32 32 95 32
10 124 32 124 32 124 32 124 32 32 32
32 32 32 32 32 32 32 32 32 32 32
32 32 32 32 32 32 124 32 124 95 32
32 32 95 124 32 95 95 95 32 92 47
32 32 95 95 32 92 32 32 32 124 32
124 10 124 32 124 32 124 32 124 95 32
95 95 32 32 95 32 95 95 32 95 95
95 32 32 95 95 32 95 124 32 124 32
124 32 124 32 124 32 124 95 47 32 47
124 32 47 32 32 92 47 32 95 95 124
32 124 10 124 32 124 32 124 32 124 32
39 95 32 92 124 32 39 95 95 47 32
95 32 92 47 32 95 96 32 124 32 124
32 124 32 124 32 124 32 32 32 32 47
32 124 32 124 32 32 32 32 47 32 95
96 32 124 10 124 32 124 95 124 32 124
32 124 32 124 32 124 32 124 32 124 32
32 95 95 47 32 40 95 124 32 124 32
124 95 124 32 124 95 124 32 124 92 32
92 32 124 32 92 95 95 47 92 32 40
95 124 32 124 10 32 92 95 95 95 47
124 95 124 32 124 95 124 95 124 32 32
92 95 95 95 124 92 95 95 44 95 124
95 124 92 95 95 95 47 92 95 124 32
92 95 124 32 92 95 95 95 95 47 92
95 95 44 95 124 10
)

print_logo() {
    local output=""
    for code in "${UNREALLOGO_CHARS[@]}"; do
        if [ "$code" -eq 0 ]; then
            break
        fi
        if [ "$code" -eq 10 ]; then
            echo "$output"
            output=""
        else
            output+=$(printf "\\$(printf '%03o' "$code")")
        fi
    done
    # Print any remaining output
    if [ -n "$output" ]; then
        echo "$output"
    fi
}

print_icon() {
    echo -e "${BLUE}    ▒▒▒▒▒▒▒▒▒▒▒▒    "
    echo "  ▒▒▒▓▓▓▓▓▓▓▓▓▓▒▒░  "
    echo " ▒▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▒▒ "
    echo "▒▒▓▓▓▓▒░▒▓▓▓▒▒▒▓▓▓▒░      UnrealIRCd"
    echo "▒▓▓▓▓▓▒░▒▓▓▓░░▒▓▓▓▓▒ \"Serving thousands of"
    echo "▒▓▓▓▓▒░░▒▓▓▒░░▓▓▓▓▓▒  networks since 1999\""
    echo "▒▓▓▓▓▒░░▓▓▓▒░▒▓▓▓▓▓▒"
    echo "▒▒▓▓▓▒░░░░░░▒▓▓▓▓▓▒▒"
    echo " ▒▒▓▓▓▒▒▒▒▒▒▓▓▓▓▓▒▒ "
    echo "  ▒▒▒▓▓▓▓▓▓▓▓▓▓▒▒░  "
    echo "    ▒▒▒▒▒▒▒▒▒▒▒░    "
    echo -e "${NC}"
}

print_header() {
    echo -e "${BLUE}"
    print_icon
    echo "Web Panel v2.0"
    echo "Brought to you by Valware"
    echo -e "${NC}"
}

print_success() {
    echo -e "${GREEN}✓ $1${NC}"
}

print_error() {
    echo -e "${RED}✗ $1${NC}"
}

print_info() {
    echo -e "${YELLOW}→ $1${NC}"
}

check_dependencies() {
    local missing=0
    
    if ! command -v go &> /dev/null; then
        print_error "Go is not installed"
        missing=1
    fi
    
    if ! command -v node &> /dev/null; then
        print_error "Node.js is not installed"
        missing=1
    fi
    
    if ! command -v npm &> /dev/null; then
        print_error "npm is not installed"
        missing=1
    fi
    
    if [ $missing -eq 1 ]; then
        echo ""
        print_error "Please install missing dependencies and try again"
        exit 1
    fi
    
    print_success "All dependencies found"
}

build_frontend() {
    print_info "Building frontend..."
    cd "$FRONTEND_DIR"
    
    # Install dependencies if node_modules doesn't exist or package.json changed
    if [ ! -d "node_modules" ] || [ "package.json" -nt "node_modules" ]; then
        print_info "Installing frontend dependencies..."
        npm install
    fi
    
    # Build frontend
    npm run build
    
    # Copy built files to backend
    print_info "Copying frontend build to backend..."
    rm -rf "$BACKEND_DIR/frontend"
    cp -r "$FRONTEND_DIR/dist" "$BACKEND_DIR/frontend"
    
    print_success "Frontend built successfully"
}

build_backend() {
    print_info "Building backend..."
    cd "$BACKEND_DIR"
    
    # Download dependencies if needed
    if [ ! -d "vendor" ] && [ -f "go.mod" ]; then
        print_info "Downloading Go dependencies..."
        go mod download
    fi
    
    # Build binary
    go build -o "$BINARY_NAME" ./cmd/server/
    
    print_success "Backend built successfully"
}

build_all() {
    print_header
    check_dependencies
    echo ""
    build_frontend
    echo ""
    build_backend
    echo ""
    print_success "Build complete! Run './uwp start' to start the server"
}

start_server() {
    cd "$BACKEND_DIR"
    
    # Kill any orphaned webpanel processes
    pkill -f "./webpanel" 2>/dev/null || true
    sleep 1
    
    if [ -f "$PID_FILE" ]; then
        local pid=$(cat "$PID_FILE")
        if ps -p "$pid" > /dev/null 2>&1; then
            print_error "Server is already running (PID: $pid)"
            echo "Use './uwp stop' to stop it first, or './uwp restart' to restart"
            exit 1
        else
            rm -f "$PID_FILE"
        fi
    fi
    
    if [ ! -f "$BINARY_NAME" ]; then
        print_error "Binary not found. Please run './uwp build' first"
        exit 1
    fi
    
    print_info "Starting UnrealIRCd Web Panel..."
    
    # Create data directory if it doesn't exist
    mkdir -p "$BACKEND_DIR/data"
    
    # Start server in background
    nohup "./$BINARY_NAME" >> "$BACKEND_DIR/data/webpanel.log" 2>&1 &
    local pid=$!
    echo $pid > "$PID_FILE"
    
    sleep 3
    
    if ps -p "$pid" > /dev/null 2>&1; then
        print_success "Server started (PID: $pid)"
        echo ""
        echo "Web panel is now available at: http://localhost:8080"
        echo "Logs: $BACKEND_DIR/data/webpanel.log"
        echo ""
        
        # Show recent startup logs including any admin user creation messages
        if [ -f "$BACKEND_DIR/data/webpanel.log" ]; then
            echo "Recent startup logs:"
            tail -10 "$BACKEND_DIR/data/webpanel.log" | grep -E "(admin|password|change|Please|Created|user)" || true
            echo ""
        fi
    else
        print_error "Server failed to start. Check logs at $BACKEND_DIR/data/webpanel.log"
        rm -f "$PID_FILE"
        exit 1
    fi
}

stop_server() {
    if [ ! -f "$PID_FILE" ]; then
        print_info "Server is not running (no PID file found)"
        return 0
    fi
    
    local pid=$(cat "$PID_FILE")
    
    if ! ps -p "$pid" > /dev/null 2>&1; then
        print_info "Server is not running (stale PID file)"
        rm -f "$PID_FILE"
        return 0
    fi
    
    print_info "Stopping server (PID: $pid)..."
    kill "$pid" 2>/dev/null || true
    
    # Wait for graceful shutdown
    local count=0
    while ps -p "$pid" > /dev/null 2>&1 && [ $count -lt 10 ]; do
        sleep 1
        count=$((count + 1))
    done
    
    # Force kill if still running
    if ps -p "$pid" > /dev/null 2>&1; then
        print_info "Force stopping server..."
        kill -9 "$pid" 2>/dev/null || true
    fi
    
    rm -f "$PID_FILE"
    print_success "Server stopped"
}

restart_server() {
    stop_server
    echo ""
    start_server
}

server_status() {
    if [ ! -f "$PID_FILE" ]; then
        echo "Server is not running"
        return 1
    fi
    
    local pid=$(cat "$PID_FILE")
    
    if ps -p "$pid" > /dev/null 2>&1; then
        echo -e "${GREEN}Server is running${NC} (PID: $pid)"
        return 0
    else
        echo "Server is not running (stale PID file)"
        rm -f "$PID_FILE"
        return 1
    fi
}

show_logs() {
    local log_file="$BACKEND_DIR/data/webpanel.log"
    
    if [ ! -f "$log_file" ]; then
        print_error "Log file not found"
        exit 1
    fi
    
    if [ "$1" == "-f" ] || [ "$1" == "--follow" ]; then
        tail -f "$log_file"
    else
        tail -100 "$log_file"
    fi
}

run_dev() {
    print_header
    print_info "Starting development mode..."
    echo ""
    
    # Start backend
    print_info "Starting backend..."
    cd "$BACKEND_DIR"
    if [ ! -f "$BINARY_NAME" ]; then
        build_backend
    fi
    "./$BINARY_NAME" &
    local backend_pid=$!
    
    sleep 2
    
    # Start frontend dev server
    print_info "Starting frontend dev server..."
    cd "$FRONTEND_DIR"
    npm run dev &
    local frontend_pid=$!
    
    echo ""
    print_success "Development servers started"
    echo "Backend:  http://localhost:8080"
    echo "Frontend: http://localhost:5173"
    echo ""
    echo "Press Ctrl+C to stop both servers"
    
    # Trap Ctrl+C to clean up
    trap "kill $backend_pid $frontend_pid 2>/dev/null; exit 0" SIGINT SIGTERM
    
    wait
}

clean() {
    print_info "Cleaning build artifacts..."
    
    # Clean backend
    rm -f "$BACKEND_DIR/$BINARY_NAME"
    rm -rf "$BACKEND_DIR/frontend"
    
    # Clean frontend
    rm -rf "$FRONTEND_DIR/dist"
    rm -rf "$FRONTEND_DIR/node_modules/.vite"
    
    print_success "Clean complete"
}

show_help() {
    print_header
    echo "Usage: ./uwp <command>"
    echo ""
    echo "Commands:"
    echo "  build       Build both frontend and backend"
    echo "  build-fe    Build frontend only"
    echo "  build-be    Build backend only"
    echo "  start       Start the web panel server"
    echo "  stop        Stop the web panel server"
    echo "  restart     Restart the web panel server"
    echo "  status      Check if server is running"
    echo "  logs        Show recent logs (add -f to follow)"
    echo "  dev         Start development mode (both frontend & backend)"
    echo "  clean       Remove build artifacts"
    echo "  help        Show this help message"
    echo ""
    echo "Examples:"
    echo "  ./uwp build          # Build everything"
    echo "  ./uwp start          # Start the server"
    echo "  ./uwp logs -f        # Follow logs"
    echo "  ./uwp restart        # Restart the server"
}

# Main command handler
case "${1:-}" in
    build)
        build_all
        ;;
    build-fe|build-frontend)
        print_header
        build_frontend
        ;;
    build-be|build-backend)
        print_header
        build_backend
        ;;
    start)
        start_server
        ;;
    stop)
        stop_server
        ;;
    restart)
        restart_server
        ;;
    status)
        server_status
        ;;
    logs)
        show_logs "$2"
        ;;
    dev)
        run_dev
        ;;
    clean)
        clean
        ;;
    help|--help|-h)
        show_help
        ;;
    "")
        show_help
        ;;
    *)
        print_error "Unknown command: $1"
        echo ""
        show_help
        exit 1
        ;;
esac
